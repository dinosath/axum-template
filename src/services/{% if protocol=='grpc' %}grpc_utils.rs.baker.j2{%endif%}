use sea_orm::{DatabaseConnection, EntityTrait};
use log::{debug, error};
use tonic::Status;
{% if id_type == 'uuid' -%}
use uuid::Uuid;

pub fn parse_id(id: &str) -> Result<Uuid, Status> {
    Uuid::parse_str(id).map_err(|e| Status::invalid_argument(format!("Invalid UUID: {}", e)))
}

pub async fn find_model_by_id<E>(
    db: &DatabaseConnection,
    id: &str,
) -> Result<E::Model, Status>
where
    E: EntityTrait,
    <E as EntityTrait>::Model: Send + Sync, <<E as EntityTrait>::PrimaryKey as sea_orm::PrimaryKeyTrait>::ValueType: From<Uuid>
{
    let parsed_id = parse_id(id)?;
{% else -%}
pub fn parse_id(id: &str) -> Result<i32, Status> {
    id.parse::<i32>().map_err(|e| Status::invalid_argument(format!("Invalid ID: {}", e)))
}

pub async fn find_model_by_id<E>(
    db: &DatabaseConnection,
    id: &str,
) -> Result<E::Model, Status>
where
    E: EntityTrait,
    <E as EntityTrait>::Model: Send + Sync, <<E as EntityTrait>::PrimaryKey as sea_orm::PrimaryKeyTrait>::ValueType: From<i32>
{
    let parsed_id = parse_id(id)?;
{% endif -%}
    let model = E::find_by_id(parsed_id).one(db).await
        .map_err(|e| {
            error!("Database error: {}", e);
            Status::internal("Internal server error")
        })?;
    if model.is_none() {
        let table = E::default().table_name().to_owned();
        debug!("Entity with id:[{}] not found in table [{}]", id, table);
    }
    model.ok_or_else(|| Status::not_found(format!("Entity by id:[{:?}] not found", id)))
}

#[cfg(test)]
mod tests {
    use super::*;

{% if id_type == 'uuid' -%}
    #[test]
    fn test_parse_id_valid() {
        let uuid_str = "550e8400-e29b-41d4-a716-446655440000";
        let result = parse_id(uuid_str);
        assert!(result.is_ok());
        assert_eq!(result.unwrap().to_string(), uuid_str);
    }

    #[test]
    fn test_parse_id_invalid() {
        let invalid_uuid = "not-a-uuid";
        let result = parse_id(invalid_uuid);
        assert!(result.is_err());
        let err = result.unwrap_err();
        assert_eq!(err.code(), tonic::Code::InvalidArgument);
        assert!(err.message().contains("Invalid UUID"));
    }
{% else -%}
    #[test]
    fn test_parse_id_valid() {
        let id_str = "123";
        let result = parse_id(id_str);
        assert!(result.is_ok());
        assert_eq!(result.unwrap(), 123);
    }

    #[test]
    fn test_parse_id_invalid() {
        let invalid_id = "not-a-number";
        let result = parse_id(invalid_id);
        assert!(result.is_err());
        let err = result.unwrap_err();
        assert_eq!(err.code(), tonic::Code::InvalidArgument);
        assert!(err.message().contains("Invalid ID"));
    }
{% endif -%}
}