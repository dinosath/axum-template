#!/usr/bin/env bash
set -e

echo "ğŸ” Checking submodules for uncommitted changes..."

git submodule update --init --recursive

git submodule foreach --recursive '
  set -e

  # Detect dirty submodule
  if ! git diff --quiet || ! git diff --cached --quiet; then
    echo "ğŸ“¦ Changes detected in submodule: $name"

    # Ensure we are on a branch
    branch=$(git symbolic-ref --short HEAD || true)
    if [ -z "$branch" ]; then
      echo "âŒ Submodule $name is in detached HEAD"
      exit 1
    fi

    # Auto-commit changes
    git add -A
    git commit -m "chore: auto-commit from parent repo"

    echo "âœ… Committed changes in $name"
  fi
'

echo "ğŸ“Œ Staging updated submodule references..."
git add $(git submodule--helper list | awk "{print \$4}")

echo "âœ… Submodule commits complete"
